<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sickSa.mapper.IngredientsMapper">
	
	<resultMap id="INGREDIENT_CATEGORIES" type="sickSa.domain.IngredientCategories">
		<result column="IGCT_ID" property="igct_id"/>
		<result column="IGCT_NAME" property="igct_name"/>
	</resultMap>
	
	<resultMap id="INGREDIENT_DETAILS" type="sickSa.domain.IngredientDetails">
		<result column="ING_ID" property="ing_id"/>
		<result column="IGDT_IN" property="igdt_in"/>
		<result column="IGDT_OUT" property="igdt_out"/>
		<result column="IGDT_PRICE" property="igdt_price"/>
		<result column="IGDT_CONTACT" property="igdt_contact"/>
		<result column="IGCT_ID" property="igct_id"/>
		<!-- 
		<association 
				resultMap="INGREDIENT_CATEGORIES"
				property="igct_id" 
				select="sickSa.mapper.IngredientCategoriesMapper.selectIngredientCategoriesById"/> 
		-->
	</resultMap>
	
	<resultMap id="INGREDIENTS" type="sickSa.domain.Ingredients">
		<result column="ING_ID" property="ing_id"/>
		<result column="ING_NAME" property="ing_name"/>
		<result column="ING_STOCK" property="ing_stock"/>
		<result column="ING_MEASURE" property="ing_measure"/>
		<association 
				resultMap="INGREDIENT_DETAILS"
				property="ingredientDetails"
				/>
		<association 
				resultMap="INGREDIENT_CATEGORIES"
				property="ingredientCategories"
				/>
	</resultMap>
	
	<resultMap id="PDIG" type="sickSa.domain.ProductIngredients">
		<result column="PDT_ID" property="PDT_ID"/>
		<association property="PDIG_AMOUNTS" javaType="java.util.Map">
			<result property="key" column="ING_ID"/>
			<result property="value" column="PDIG_AMOUNT"/>
		</association>
	</resultMap>
	
	<select 
		id="listIngredient" 
		resultType="sickSa.domain.Ingredients">
		SELECT ING_ID,ING_NAME,ING_STOCK,ING_MEASURE
		FROM INGREDIENTS
	</select>
	
	<select 
		id="cateIngList" 
		parameterType="java.lang.Integer" 
		resultMap="INGREDIENTS">
		SELECT 
			ING_ID,ING_NAME,ING_STOCK,ING_MEASURE,IGDT_IN,IGDT_OUT,IGDT_PRICE,IGDT_CONTACT,IGCT_ID,IGCT_NAME
		FROM 
			INGREDIENTS ing
		NATURAL JOIN 
			INGREDIENT_DETAILS igdt
		NATURAL JOIN 
			INGREDIENT_CATEGORIES igct
		WHERE 
			igct.IGCT_NAME = #{IGCT_NAME};
	</select>
	
	<select 
		id="selectIngredientById" 
		parameterType="java.lang.Integer" 
		resultType="sickSa.domain.Ingredients">
		SELECT ING_ID,ING_NAME,ING_STOCK,ING_MEASURE
		FROM INGREDIENTS
		WHERE ING_ID=#{ING_ID}
	</select>
	
	<insert 
		id="insertIngredient"
		parameterType="sickSa.domain.Ingredients">
		<selectKey 
			keyProperty="ING_ID" 
			resultType="java.lang.Integer"
			order="BEFORE">
			SELECT INGREDIENTS_ING_ID_SEQ.nextval FROM DUAL
		</selectKey>
		INSERT INTO INGREDIENTS(ING_ID,ING_NAME,ING_STOCK,ING_MEASURE)
		VALUES (#{ING_ID},#{ING_NAME},#{ING_STOCK},#{ING_MEASURE})
	</insert>
	
	<delete 
		id="deleteIngredient"
		parameterType="java.lang.Integer">
		DELETE FROM INGREDIENTS
		WHERE ING_ID=#{ING_ID}
	</delete>
	
	<update 
		id="updateIngredient"
		>
		UPDATE INGREDIENTS
		SET ING_NAME=#{ING_NAME},ING_STOCK=#{ING_STOCK},
			ING_MEASURE=#{ING_MEASURE}
		WHERE ING_ID = #{ING_ID}
	</update> 
	
	<!-- 	
	<foreach item="item" index="index" collection="list"
      open="(" separator="," close=")">
        #{item}
  	</foreach>
  	Map을 사용할때 index는 key객체가 되고 항목은 value객체가 된다.
	-->
	
	<update 
		id="changeStock"
		parameterType="sickSa.domain.ProductIngredients">
		<bind name="ING_ID" value="_parameter.getPDIG_AMOUNT()"/>
		<bind name="PDIG_AMOUNT" value="_parameter."/>
		UPDATE INGREDIENTS
		<foreach item="item" index="index" collection="list"
      		open="(" separator="," close=")">
		SET ING_STOCK= (SELECT ING_STOCK
		                FROM INGREDIENTS
		                WHERE ING_ID= #{item) - #{index}
		WHERE ING_ID = #{item};
		</foreach>
	</update>  
	
	<!-- <update 
		id="changeStock"
		parameterType="sickSa.domain.ProductIngredients">
		UPDATE INGREDIENTS
		SET ING_STOCK= (SELECT ING_STOCK
		                FROM INGREDIENTS
		                WHERE ING_ID= #{ING_ID, resultMap=PDIG}) - #{PDIG_AMOUNT, resultMap=PDIG}
		WHERE ING_ID = #{ING_ID, resultMap=PDIG};
	</update>  -->
	
</mapper>